# UE4物理模块 03 碰撞查询
这一章最好自己亲自画图  
人物的移动,移动距离s=v*t,在游戏里,时间t很小,将人物SetActorLocation到这个小移动量表示的世界坐标里  

在每次计算移动位移时,都会进行碰撞查询,具体是用人物的胶囊体向速度方向进行扫略,它返回的结果是一个比例  
如果比例是1.0,就执行完整的移动,如果比例是0.5,就只进行一半长度的位移,如果比例是0,就不移动  

PhysX将碰撞查询分成broad phase,mid phase, narrow phase三个阶段  
前两个阶段利用空间相关性,过滤掉空间相差太远而不可能发生碰撞的对象  
使用物理的AABB包围盒进行计算,包围盒的每条边都与相应的XYZ轴平行  
常用SAP算法,MBP算法与AABB树(BVH)算法  

两物体碰撞的充要条件是,在所有轴上的各自最大值>另一方的最小值  

## SAP算法
PhysX在broad phase采用Sweep and Prune(SAP, Prune: 剪枝,修剪)算法  
它将所有物体AABB盒的min点与max点分别在XYZ轴上投影  
如果在某一轴上不满足max1>min2 && max2>mix1,则不会发生碰撞  

1. 排序  

A: --------  
B: ****---------------------  
C: ******------  
D: ******************------  

对ABCD四个图形按最小点排序(*代表空白)  

2. 建立碰撞可能性列表List_X  

对每个对象进行遍历,先检测A,将{A,B},{A,C}加入List_X,D之后的都不可能发生碰撞  
再回到外层循环检测B,C,D...  
最后得到可能性列表List_X=[AB,AC,BC,BD]  

3. 对其它轴进行检测  
在List_X的基础上进行Y轴和Z轴的检测,不通过就直接从List_X中排除  

### MBP算法
SAP的改进算法,Multi Box Pruning,将世界划分成网格,在每一个网格中进行局部的SAP  

1. 计算所有对象的整体包围盒  
2. 切分这个包围盒,划分成4个子计算区间  
3. 按各自区域进行分类  
4. 考虑轴线上的物体的归属,因落到了多个区域,所以这些区域内都需要添加  
在实际计算中,会在多个区域内检测碰撞,如果碰撞列表用hashmap来做,就不用担心重复性  
5. 对每个区域递归的进行划分,直到区域足够小,然后在每个小区域内进行经典SAP的计算  

### AABB树算法 / BVH算法
AABB树,又名Bounding Volume Hierarchical Tree(BVH)树,也可用于broad phase/mid phase的计算  

简单来讲是一个二叉树,根节点表示能包括所有对象的AABB盒,然后向下的分支节点表示能包含内部对象的AABB盒  
叶节点表示一个具体的对象,这样对于一个对象,它向上的父结点依次是包含自己的更大的AABB盒  

查询时先检测根节点,如果相交再检测左右子分支节点,如果相交再继续检查分支节点  
直到叶节点时(此时代表具体对象,前面的都是AABB盒),如果相交就加入潜在碰撞列表中  

得到潜在的碰撞列表后,再用narrow phase来决定最终碰撞  

