# AI 04 运行行为树-处理请求
## 目录
- [AI 04 运行行为树-处理请求](#ai-04-运行行为树-处理请求)
  - [目录](#目录)
  - [参考](#参考)
  - [概述](#概述)
  - [ProcessExecutionRequest](#processexecutionrequest)
  - [TODO](#todo)
## 参考
@左未 [【图解UE4源码】 其三（二）行为树系统执行任务的流程 处理请求](https://zhuanlan.zhihu.com/p/373072168)  

## 概述
`RequestExecution`设置了`ExecutionRequest`,然后标记`bRequestedFlowUpdate`为true,在下一帧就会调用`ProcessExecutionRequest`  

```
void UBehaviorTreeComponent::TickComponent(float DeltaTime, enum ELevelTick TickType, FActorComponentTickFunction *ThisTickFunction)
{
    if (bRequestedFlowUpdate)
    {
        ProcessExecutionRequest();
    }
}
```

## ProcessExecutionRequest
1. 将InstanceStack中的内存拷贝到KnownInstances中,以防后面要回滚  
2. 反激活从ActiveNode到ExecutionRequest.ExecuteNode的所有结点  

```
void UBehaviorTreeComponent::ProcessExecutionRequest()
{
  UBTTaskNode* NextTask = NULL;

  if (InstanceStack[ActiveInstanceIdx].ActiveNode != ExecutionRequest.ExecuteNode)
  {
    int32 LastDeactivatedChildIndex = INDEX_NONE;
		const bool bDeactivated = DeactivateUpTo(ExecutionRequest.ExecuteNode, ExecutionRequest.ExecuteInstanceIdx, NodeResult, LastDeactivatedChildIndex);
  }
}
```

## TODO
DeactivateUpTo