# AI 04 运行行为树-处理请求
## 目录
- [AI 04 运行行为树-处理请求](#ai-04-运行行为树-处理请求)
  - [目录](#目录)
  - [参考](#参考)
  - [概述](#概述)
  - [ProcessExecutionRequest](#processexecutionrequest)
    - [反激活从ActiveNode到ExecutionRequest.ExecuteNode的所有结点](#反激活从activenode到executionrequestexecutenode的所有结点)
## 参考
@左未 [【图解UE4源码】 其三（二）行为树系统执行任务的流程 处理请求](https://zhuanlan.zhihu.com/p/373072168)  

## 概述
`RequestExecution`设置了`ExecutionRequest`,然后标记`bRequestedFlowUpdate`为true,在下一帧就会调用`ProcessExecutionRequest`  

```
void UBehaviorTreeComponent::TickComponent(float DeltaTime, enum ELevelTick TickType, FActorComponentTickFunction *ThisTickFunction)
{
    if (bRequestedFlowUpdate)
    {
        ProcessExecutionRequest();
    }
}
```

## ProcessExecutionRequest
1. 将InstanceStack中的内存拷贝到KnownInstances中,以防后面要回滚  
2. 反激活从ActiveNode到ExecutionRequest.ExecuteNode的所有结点  

```
void UBehaviorTreeComponent::ProcessExecutionRequest()
{
  UBTTaskNode* NextTask = NULL;

  if (InstanceStack[ActiveInstanceIdx].ActiveNode != ExecutionRequest.ExecuteNode)
  {
    int32 LastDeactivatedChildIndex = INDEX_NONE;
		const bool bDeactivated = DeactivateUpTo(ExecutionRequest.ExecuteNode, ExecutionRequest.ExecuteInstanceIdx, NodeResult, LastDeactivatedChildIndex);
  }
}
```

### 反激活从ActiveNode到ExecutionRequest.ExecuteNode的所有结点
本质上是将从ActiveNode到ExecutionRequest.ExecuteNode的所有子结点的Service和Decorator,加入SearchData.PendingUpdates,模式为EBTNodeUpdateMode::Remove,后面在`ProcessPendingExecution`中执行

1. `UBehaviorTreeComponent::DeactivateUpTo`,参数Node是ExecutionRequest.ExecuteNode,一般是ActiveNode的直接上级,while循环执行一次  

```
bool UBehaviorTreeComponent::DeactivateUpTo(UBTCompositeNode* Node, uint16 NodeInstanceIdx, EBTNodeResult::Type& NodeResult, int32& OutLastDeactivatedChildIndex)
{
  UBTNode* DeactivatedChild = InstanceStack[ActiveInstanceIdx].ActiveNode;

  while (DeactivatedChild)
  {
    UBTCompositeNode* NotifyParent = DeactivatedChild->GetParentNode();
		if (NotifyParent)
		{
			OutLastDeactivatedChildIndex = NotifyParent->GetChildIndex(SearchData, *DeactivatedChild);
			NotifyParent->OnChildDeactivation(SearchData, OutLastDeactivatedChildIndex, NodeResult);

			DeactivatedChild = NotifyParent;
		}

    if (DeactivatedChild == Node)
		{
			break;
		}
  }
}
```

2. `UBTCompositeNode::OnChildDeactivation`,如果是Task,移除Service,如果是Composite,调用OnNodeDeactivation

```
void UBTCompositeNode::OnChildDeactivation(FBehaviorTreeSearchData& SearchData, int32 ChildIndex, EBTNodeResult::Type& NodeResult) const
{
  const FBTCompositeChild& ChildInfo = Children[ChildIndex];

  if (ChildInfo.ChildTask)
	{
		for (int32 ServiceIndex = 0; ServiceIndex < ChildInfo.ChildTask->Services.Num(); ServiceIndex++)
		{
			SearchData.AddUniqueUpdate(FBehaviorTreeSearchUpdate(ChildInfo.ChildTask->Services[ServiceIndex], SearchData.OwnerComp.GetActiveInstanceIdx(), EBTNodeUpdateMode::Remove));
		}
	}
	else if (ChildInfo.ChildComposite)
	{
		ChildInfo.ChildComposite->OnNodeDeactivation(SearchData, NodeResult);
	}
}
```

3. `UBTCompositeNode::OnNodeDeactivation`,将Service和所有子节点的辅助节点加入SearchData,mode=remove.移除SearchData中,所有子节点mode=add  
